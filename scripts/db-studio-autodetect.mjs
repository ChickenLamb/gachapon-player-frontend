#!/usr/bin/env node

/**
 * Drizzle Studio Auto-Detection Script
 * =====================================
 *
 * Purpose:
 *   Automatically discovers local Cloudflare D1 database created by miniflare/wrangler
 *   and launches Drizzle Studio with the correct database path - no manual configuration needed.
 *
 * Context Boundary: Database Development Tools
 *   - Interacts with: .wrangler/state (miniflare D1), drizzle.config.local.ts, wrangler CLI
 *   - Purpose: Bridge between Cloudflare D1 local development and Drizzle Studio
 *   - Scope: Development environment only (local database inspection)
 *
 * Workflow:
 *   1. Searches .wrangler/state/v3/d1/miniflare-D1DatabaseObject/ for .sqlite files
 *   2. Validates database accessibility via `wrangler d1 execute` test query
 *   3. Auto-generates drizzle.config.local.ts with correct database path
 *   4. Launches Drizzle Studio pointing to detected database
 *
 * Error Handling:
 *   - Graceful failures with actionable error messages
 *   - Validates database exists before attempting connection
 *   - Tests wrangler configuration before launching Studio
 *
 * Usage:
 *   pnpm run db:studio
 *   (defined in package.json as: "db:studio": "node scripts/db-studio-autodetect.mjs")
 *
 * Prerequisites:
 *   - Local D1 database must exist (created by `pnpm run dev` or `pnpm run preview`)
 *   - wrangler.jsonc must have correct d1_databases configuration
 *   - database_name must be "etee" in wrangler.jsonc
 *
 * @file scripts/db-studio-autodetect.mjs
 * @author Auto-generated for SvelteKit + Cloudflare D1 + Drizzle ORM template
 * @since 2025-11-12
 */

import { execSync } from 'child_process';
import { existsSync, readdirSync, writeFileSync } from 'fs';
import { join } from 'path';

// ============================================================================
// USER CONFIGURATION (Optional Override)
// ============================================================================
// Uncomment to manually specify database path instead of auto-detection:
//
// const MANUAL_DB_PATH = '.wrangler/state/v3/d1/miniflare-D1DatabaseObject/your-hash.sqlite';
//
// When to use manual override:
// - You want to inspect a specific database file
// - Auto-detection finds wrong database
// - You have multiple database files
//
// Example:
// const MANUAL_DB_PATH = '.wrangler/state/v3/d1/miniflare-D1DatabaseObject/88d0492543894f64faa3e01f1091557658117f6fe88b7e5c605836ba4f8b98b5.sqlite';
// ============================================================================

const MANUAL_DB_PATH = undefined; // Leave undefined for auto-detection

// Configuration constants
const WRANGLER_D1_DIR = '.wrangler/state/v3/d1/miniflare-D1DatabaseObject';
const CONFIG_FILE = 'drizzle.config.local.ts';
const DATABASE_NAME = 'etee'; // Must match wrangler.jsonc d1_databases[].database_name

/**
 * Find the local D1 database file created by miniflare
 *
 * Searches the miniflare D1 directory for .sqlite files.
 * The filename is a hash that's unique per database instance.
 *
 * @returns {string|null} Relative path to .sqlite file, or null if not found
 */
function findLocalDatabase() {
	if (!existsSync(WRANGLER_D1_DIR)) {
		return null;
	}

	const files = readdirSync(WRANGLER_D1_DIR);
	const dbFile = files.find(f => f.endsWith('.sqlite'));

	if (!dbFile) {
		return null;
	}

	return join(WRANGLER_D1_DIR, dbFile);
}

/**
 * Verify database is accessible using wrangler
 *
 * Executes a simple SELECT 1 query against the local database
 * to ensure wrangler can connect and the configuration is correct.
 *
 * @returns {boolean} True if database is accessible, false otherwise
 */
function verifyDatabase() {
	try {
		execSync(`npx wrangler d1 execute ${DATABASE_NAME} --local --command "SELECT 1"`, {
			stdio: 'pipe',
			encoding: 'utf-8'
		});
		return true;
	} catch (error) {
		return false;
	}
}

/**
 * Update drizzle.config.local.ts with the correct database path
 *
 * Generates a fresh configuration file pointing to the detected
 * local database. The file is marked as auto-generated to indicate
 * it should not be manually edited.
 *
 * @param {string} dbPath - Relative path to the .sqlite database file
 */
function updateConfig(dbPath) {
	const config = `import { defineConfig } from 'drizzle-kit';

/**
 * âš ï¸âš ï¸âš ï¸ AUTO-GENERATED FILE - DO NOT EDIT MANUALLY âš ï¸âš ï¸âš ï¸
 *
 * This file is automatically regenerated by: scripts/db-studio-autodetect.mjs
 * When you run: pnpm run db:studio
 *
 * Purpose:
 *   - Inspect local miniflare D1 database with Drizzle Studio
 *   - Points to the current local SQLite file in .wrangler/state/
 *
 * Why auto-generated?
 *   - Database file path contains a unique hash per machine/database
 *   - Hash changes when database is recreated
 *   - Script auto-detects the current path and updates this file
 *
 * âš ï¸ MANUAL EDITS TO THIS FILE WILL BE OVERWRITTEN
 *
 * To customize database path:
 *   1. Open: scripts/db-studio-autodetect.mjs
 *   2. Uncomment and set: MANUAL_DB_PATH = 'path/to/your/database.sqlite'
 *   3. Run: pnpm run db:studio (will use your manual path)
 *
 * Alternative:
 *   - Run drizzle-kit studio directly with your own config file
 *
 * No API credentials needed - just points to local SQLite file.
 */

export default defineConfig({
	schema: './src/lib/server/db/schema.ts',
	dialect: 'sqlite',
	dbCredentials: {
		// âš ï¸ AUTO-DETECTED PATH - Will be overwritten on next run
		url: 'file:${dbPath}'
	}
});
`;

	writeFileSync(CONFIG_FILE, config, 'utf-8');
}

/**
 * Main execution flow
 *
 * Orchestrates the complete workflow:
 * 1. Database discovery
 * 2. Connection validation
 * 3. Config file generation
 * 4. Drizzle Studio launch
 */
async function main() {
	console.log('ğŸ” Looking for local D1 database...');

	// Step 1: Find the database file (or use manual override)
	let dbPath = MANUAL_DB_PATH;

	if (dbPath) {
		console.log(`ğŸ“Œ Using manual database path: ${dbPath}`);

		// Validate manual path exists
		if (!existsSync(dbPath)) {
			console.error(`âŒ Error: Manual database path does not exist: ${dbPath}`);
			console.error('');
			console.error('Please check the path or remove MANUAL_DB_PATH to use auto-detection.');
			process.exit(1);
		}
	} else {
		dbPath = findLocalDatabase();
	}

	if (!dbPath) {
		console.error('âŒ Error: Local D1 database not found!');
		console.error('');
		console.error('Please ensure you have run one of the following:');
		console.error('  â€¢ pnpm run dev        (starts dev server with miniflare)');
		console.error('  â€¢ pnpm run preview    (starts preview with wrangler)');
		console.error('');
		console.error('The dev/preview server must be running to create the local database.');
		process.exit(1);
	}

	console.log(`âœ… Found database: ${dbPath}`);

	// Step 2: Verify database is accessible
	console.log('ğŸ§ª Testing database connection...');
	const isValid = verifyDatabase();

	if (!isValid) {
		console.error('âŒ Error: Database exists but is not accessible via wrangler!');
		console.error('');
		console.error('Please ensure:');
		console.error(`  â€¢ wrangler.jsonc has correct d1_databases configuration`);
		console.error(`  â€¢ database_name matches "${DATABASE_NAME}"`);
		console.error('');
		process.exit(1);
	}

	console.log('âœ… Database connection verified');

	// Step 3: Update config file
	console.log(`ğŸ“ Updating ${CONFIG_FILE}...`);
	updateConfig(dbPath);
	console.log('âœ… Configuration updated');

	// Step 4: Start Drizzle Studio
	console.log('');
	console.log('ğŸš€ Starting Drizzle Studio...');
	console.log('   Open: http://localhost:4983');
	console.log('');

	try {
		execSync('npx drizzle-kit studio --config=drizzle.config.local.ts', {
			stdio: 'inherit'
		});
	} catch (error) {
		// User likely pressed Ctrl+C to exit
		console.log('');
		console.log('ğŸ‘‹ Drizzle Studio closed');
		process.exit(0);
	}
}

// Execute main function
main().catch(error => {
	console.error('âŒ Unexpected error:', error.message);
	process.exit(1);
});

# Docker Compose Development Environment for Gachapon Player Frontend
# Features: Hot-reload with Docker Compose Watch, Vite HMR support
# Usage: docker compose -f docker/dev/docker-compose.yml watch

services:
  # SvelteKit Frontend with Vite HMR
  gachapon-player-frontend:
    build:
      context: ../..
      dockerfile: docker/dev/Dockerfile
    container_name: gachapon-player-frontend
    hostname: gachapon-player-frontend
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik-net"
      - "traefik.http.routers.gachapon-frontend.rule=Host(`gachapon-frontend.findhawker.food`)"
      - "traefik.http.routers.gachapon-frontend.entrypoints=websecure"
      - "traefik.http.routers.gachapon-frontend.tls.certresolver=cloudflare"
      - "traefik.http.services.gachapon-frontend.loadbalancer.server.port=5173"
    environment:
      # Vite configuration
      VITE_HOST: 0.0.0.0
      VITE_PORT: 5173

      # Application
      NODE_ENV: development

      # Wrangler configuration (Cloudflare Workers local dev)
      WRANGLER_LOG: info
      CLOUDFLARE_ACCOUNT_ID: ${CLOUDFLARE_ACCOUNT_ID:-local}

      # Public environment variables (available in browser)
      PUBLIC_APP_NAME: Gachapon Player
    # Ports exposed only within traefik-net (no external access)
    expose:
      - "5173"
    volumes:
      # Code volumes for hot-reload (Vite HMR handles these via bind mounts)
      - ../../src:/app/src:rw
      - ../../static:/app/static:rw
      - ../../scripts:/app/scripts:rw
      - ../../drizzle:/app/drizzle:rw
      - ../../project.inlang:/app/project.inlang:ro
      # Config files NOT in bind mounts - managed by develop.watch for auto-restart
      # - ./svelte.config.js:/app/svelte.config.js:ro    # Removed: watch handles sync+restart
      # - ./vite.config.ts:/app/vite.config.ts:ro        # Removed: watch handles sync+restart
      # - ../../tsconfig.json:/app/tsconfig.json:ro      # Removed: watch handles sync+restart
      # Static config files (no restart needed)
      - ../../wrangler.jsonc:/app/wrangler.jsonc:ro
      - ../../eslint.config.js:/app/eslint.config.js:ro
      # Persist Wrangler state (local D1 database, cache, etc.)
      - wrangler-state:/app/.wrangler
      # Exclude build artifacts and node_modules
      - /app/node_modules
      - /app/.svelte-kit
      - /app/build
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "--header=Host: localhost", "http://127.0.0.1:5173"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    networks:
      - traefik-net
    develop:
      watch:
        # NOTE: src/ and static/ are NOT watched here - Vite HMR handles them via bind mounts
        # This avoids redundant monitoring and the associated warnings

        # Watch and auto-restart on config changes
        - action: sync+restart
          path: ./svelte.config.js
          target: /app/svelte.config.js
        - action: sync+restart
          path: ./vite.config.ts
          target: /app/vite.config.ts
        - action: sync+restart
          path: ../../tsconfig.json
          target: /app/tsconfig.json

        # Rebuild container on package.json changes
        - action: rebuild
          path: ../../package.json

networks:
  traefik-net:
    external: true
    name: traefik-net

volumes:
  # Named volume for persisting Wrangler state (local D1 database, miniflare state, etc.)
  # This ensures your local database survives container restarts
  wrangler-state:
    name: gachapon-wrangler-state

# Usage Instructions:
# ===================
#
# 1. Ensure traefik-net network exists:
#    docker network create traefik-net
#
# 2. Start services with watch mode:
#    docker compose -f docker/dev/docker-compose.yml watch
#
# 3. Start services without watch:
#    docker compose -f docker/dev/docker-compose.yml up
#
# 4. Stop services:
#    docker compose -f docker/dev/docker-compose.yml down
#
# 5. Rebuild container:
#    docker compose -f docker/dev/docker-compose.yml build --no-cache
#
# 6. View logs:
#    docker compose -f docker/dev/docker-compose.yml logs -f gachapon-player-frontend
#
# 7. Execute commands in container:
#    docker compose -f docker/dev/docker-compose.yml exec gachapon-player-frontend sh
#
# Service URLs (via Traefik):
# ===========================
# Frontend: https://gachapon-frontend.findhawker.food
#
# Local Development (without Traefik):
# ====================================
# If you want to access directly without Traefik, add ports mapping:
#   ports:
#     - "5173:5173"
# Then access: http://localhost:5173
